version: '2'
services:
  chat_redis:
    image: redis
    ports:
      - "6379:6379"
    networks:
      - back-tier

  auth_redis:
    image: redis
    ports:
      - "6479:6379"
    networks:
      - back-tier

  elasticsearch:
    image: elasticsearch
    ports:
      - "9200:9200"
    networks:
      - back-tier

  auth:
    build: ./node_modules/grow-auth-service
    ports:
      - "28000:5000"
    volumes:
      - ./node_modules/grow-auth-service:/code
    depends_on:
      - auth_redis
      - elasticsearch
    links:
      - auth_redis
      - elasticsearch
    networks:
      - front-tier
      - back-tier

  chat:
    build: ./node_modules/grow-chat-service
    ports:
      - "5000"
    environment:
      VIRTUAL_HOST: "ws://*, wss://*"
      AUTH_HOST: "auth:28000"
    volumes:
      - ./node_modules/grow-chat-service:/code
    depends_on:
      - chat_redis
      - elasticsearch
    links:
      - chat_redis
      - elasticsearch
      - auth
    networks:
      - front-tier
      - back-tier

  web:
    build: ./node_modules/grow-web-service
    ports:
      - "5000"
    environment:
      VIRTUAL_HOST: "http://*"
      AUTH_HOST: "auth:28000"
    volumes:
      - ./node_modules/grow-web-service:/code
    depends_on:
      - chat_redis
      - elasticsearch
      - auth
    links:
      - chat_redis
      - elasticsearch
      - auth
    networks:
      - front-tier
      - back-tier

  lb:
    image: dockercloud/haproxy
    ports:
      - "80:80"
      - "1936:1936"
    links:
      - web
      - chat
    depends_on:
      - web
      - chat
    networks:
      - front-tier
      - back-tier
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

networks:
  front-tier:
    driver: bridge
  back-tier:
    driver: bridge
